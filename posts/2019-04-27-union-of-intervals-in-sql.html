<!DOCTYPE html><html lang="en"><head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="The Art Gallery Guardian">
    <meta name="author" content="Chao Xu">
    <meta name="google-site-verification" content="YE2oeW4OwVOPdVVfdpYIakOuD0A2Qo80W_sUbMJDGok">
    <meta name="referrer" content="origin">
    <title>Union of intervals in SQL</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-4171915-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-4171915-2');
  </script>

  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/default.css" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/blog.css" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://chaoxuprime.com/rss.xml">
  </head>
  <body>
    <header class="hide-on-print">
        <div id="site-title">
            <a href="/blog.html">The Art Gallery Guardian</a>
        </div>
    </header>
    <nav class="hide-on-print">
      <ul>
        <li><a href="/">About</a></li>
        <li><a href="/blog.html">Blog</a></li>
        <li><a href="/files/cv.pdf">CV</a></li>
        <li><a href="/tools.html">Tools</a></li>
      </ul>
    </nav>
    <main>
      <article>
        <h1 id="article-title">Union of intervals in SQL</h1>
        <br>
<div>
<h1 id="introduction"><span class="header-section-number">1</span> Introduction</h1>
<p>We given a collection of intervals, and we want to find its union, represented by a set of disjoint intervals. Assume the intervals are of the form <span class="math inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">[a,b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.16666666666666666em;"></span><span class="mord mathdefault">b</span><span class="mclose">)</span></span></span></span></span>, where <span class="math inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>a</mi><mo>&lt;</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a&lt;b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.5782em; vertical-align: -0.0391em;"></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right: 0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right: 0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault">b</span></span></span></span></span>. However, I have to solve this problem in Hive. So this is a problem I have to solve in Hive's SQL variant.</p>
<p>First, here is the schema of the table and some sample inputs.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">CREATE</span> <span class="kw">TABLE</span> t (
  a <span class="dt">int</span>,
  b <span class="dt">int</span>
);
<span class="kw">INSERT</span> <span class="kw">INTO</span> t <span class="kw">VALUES</span>
  (<span class="dv">0</span>,<span class="dv">10</span>),
  (<span class="dv">20</span>,<span class="dv">30</span>),
  (<span class="dv">5</span>,<span class="dv">15</span>);</code></pre></div>
<p>The correct output should be the following.</p>
<pre><code>a    b
-------
0    15
20   30</code></pre>
<p>We do not allow empty intervals, so we cannot have <span class="math inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>a</mi><mo>=</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a=b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right: 0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault">b</span></span></span></span></span>.</p>
<h1 id="previous-works"><span class="header-section-number">2</span> Previous Works</h1>
<p>Note this is a common interview problem, <a href="https://leetcode.com/problems/merge-intervals/">LeetCode 56. Merge Intervals</a>. I was surprised find a <a href="https://stackoverflow.com/a/8120432/303863">very short solution on stackoverflow</a>.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> 
       t1.a,
       <span class="fu">MIN</span>(t2.b) <span class="kw">AS</span> b
<span class="kw">FROM</span> t t1 
<span class="kw">INNER</span> <span class="kw">JOIN</span> t t2 <span class="kw">ON</span> t1.a &lt;= t2.b
  <span class="kw">AND</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span>(<span class="kw">SELECT</span> * <span class="kw">FROM</span> t 
                 <span class="kw">WHERE</span> t2.b &gt;= t.a <span class="kw">AND</span> t2.b &lt; t.b) 
<span class="kw">WHERE</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span>(<span class="kw">SELECT</span> * <span class="kw">FROM</span> t
                 <span class="kw">WHERE</span> t1.a &gt; t.a <span class="kw">AND</span> t1.a &lt;= t.b) 
<span class="kw">GROUP</span> <span class="kw">BY</span> t1.a
<span class="kw">ORDER</span> <span class="kw">BY</span> t1.a</code></pre></div>
<p>Unfortunately, once you know how the entire algorithm goes, one can see its performance does not look promising. Also, making it work in Hive is next to impossible due to Hive's limitations on joins and subqueries.</p>
<p><a href="http://tsql.solidq.com/">Itzik Ben-Gan</a> has <a href="https://www.itprotoday.com/development-techniques-and-management/packing-date-intervals">written</a> <a href="https://blogs.solidq.com/en/sqlserver/packing-intervals/">multiple</a> <a href="https://www.itprotoday.com/sql-server/new-solution-packing-intervals-problem">articles</a> on how to solve this problem. I recommend reading them to learn various tricks. In fact, my solution here is quite similar to one of Ben-Gan's.</p>
<h1 id="using-basic-sql"><span class="header-section-number">3</span> Using basic SQL</h1>
<p>Here we will try to implement an algorithm using the most basic of SQL, so it would even work in Hive. We first build a table, such that <span class="math inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>(</mo><mi>p</mi><mo separator="true">,</mo><mi>i</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">(p,i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">p</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.16666666666666666em;"></span><span class="mord mathdefault">i</span><span class="mclose">)</span></span></span></span></span> is in the table shows that there are precisely <span class="math inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.65952em; vertical-align: 0em;"></span><span class="mord mathdefault">i</span></span></span></span></span> points overlapping <span class="math inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span></span>.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">CREATE</span> <span class="kw">VIEW</span> r <span class="kw">AS</span> 
<span class="kw">SELECT</span> p,
       <span class="fu">SUM</span>(d) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> p <span class="kw">ROWS</span> <span class="kw">UNBOUNDED</span> <span class="kw">PRECEDING</span>) <span class="kw">AS</span> c
<span class="kw">FROM</span>  (<span class="kw">SELECT</span> p,
              <span class="fu">SUM</span>(d) <span class="kw">AS</span> d
       <span class="kw">FROM</span>   (<span class="kw">SELECT</span> a <span class="kw">AS</span> p,
                      <span class="dv">1</span> <span class="kw">AS</span> d
               <span class="kw">FROM</span>   t
               <span class="kw">UNION</span> <span class="kw">ALL</span>
               <span class="kw">SELECT</span> b  <span class="kw">AS</span> p,
                      -<span class="dv">1</span> <span class="kw">AS</span> d
               <span class="kw">FROM</span>   t) e
       <span class="kw">GROUP</span>  <span class="kw">BY</span> p) f; </code></pre></div>
<p>Next, we produce all the endpoints in the union of the intervals.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">CREATE</span> <span class="kw">VIEW</span> s <span class="kw">AS</span>
<span class="kw">SELECT</span> p
<span class="kw">FROM</span>   (<span class="kw">SELECT</span> *,
               <span class="fu">Lag</span>(c) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> p)    <span class="kw">AS</span> d 
        <span class="kw">FROM</span>   r) e
<span class="kw">WHERE</span>  c=<span class="dv">0</span> <span class="kw">OR</span> d=<span class="dv">0</span> <span class="kw">OR</span> d <span class="kw">is</span> <span class="kw">null</span>;</code></pre></div>
<p>Finally, we produce the set of intervals by pairing up adjacent rows.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> a, b
<span class="kw">FROM</span>   (<span class="kw">SELECT</span> p                              <span class="kw">AS</span> a,
               <span class="fu">Lead</span>(p) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> p)      <span class="kw">AS</span> b,
               <span class="fu">Row_number</span>() <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> p) <span class="kw">AS</span> n
        <span class="kw">FROM</span>   s) f
<span class="kw">WHERE</span>  n%<span class="dv">2</span> = <span class="dv">1</span>;</code></pre></div>
<p>You can find <a href="https://www.db-fiddle.com/f/aVaF6NDTVYmxBpifsHDFBf/5">the example in DB-fiddle</a>. I am interested to seeing simpler and faster code using the simplest of SQL.</p>

</div>
<div class="hide-on-print">
    <div class="info">Posted by <a href="https://chaoxuprime.com">Chao Xu</a> on 2019-04-27. </div>
    <div class="info">Tags: SQL, algorithm.</div>

</div>
      </article>
    </main>
    <footer class="hide-on-print">© 2010 - <time><script>document.write(new Date().getFullYear())</script></time> <a href="https://chaoxuprime.com">Chao Xu</a>. Licensed under <a href="http://www.wtfpl.net/txt/copying/">WTFPL v2</a> unless otherwise specified. <a href="/README.html">Blog README</a>.</footer>
  

</body></html>